<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amor AST Visualizer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      height: 100vh;
      gap: 1px;
      background: #2d2d2d;
    }

    .panel {
      background: #1e1e1e;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      background: #2d2d2d;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 13px;
      color: #c586c0;
      border-bottom: 1px solid #3e3e3e;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-content {
      flex: 1;
      overflow: auto;
      padding: 20px;
    }

    .source-code {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #d4d4d4;
      white-space: pre;
    }

    .keyword { color: #c586c0; font-weight: 600; }
    .type { color: #4ec9b0; }
    .function-name { color: #dcdcaa; }
    .string { color: #ce9178; }
    .comment { color: #6a9955; font-style: italic; }
    .operator { color: #d4d4d4; }
    .pattern { color: #9cdcfe; }

    .tree-node {
      margin-left: 16px;
      margin-top: 2px;
      font-size: 13px;
    }

    .tree-node-header {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
      transition: background 0.1s;
      flex-wrap: wrap;
    }

    .tree-node-header:hover {
      background: #2d2d2d;
    }

    .expand-icon {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #858585;
      font-size: 10px;
      flex-shrink: 0;
      margin-top: 3px;
    }

    .node-label {
      font-weight: 600;
      color: #4ec9b0;
    }

    .node-value {
      color: #dcdcaa;
      font-family: monospace;
    }

    .node-preview {
      color: #858585;
      font-size: 12px;
    }

    .tree-children {
      border-left: 1px solid #3e3e3e;
      margin-left: 7px;
      padding-left: 12px;
    }

    .prop-value {
      background: #252526;
      padding: 6px 10px;
      border-radius: 3px;
      margin: 4px 0 4px 22px;
      font-size: 12px;
      border-left: 2px solid #3e3e3e;
    }

    .prop-label {
      color: #9cdcfe;
      font-weight: 600;
      margin-right: 8px;
    }

    .type-expr { color: #4ec9b0; }
    .pattern-expr { color: #ce9178; }
    .expr-expr { color: #dcdcaa; }
    .string-value { color: #ce9178; }

    .json-toggle {
      background: #2d2d2d;
      border: 1px solid #3e3e3e;
      color: #858585;
      padding: 6px 12px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      margin-left: auto;
      transition: all 0.2s;
    }

    .json-toggle:hover {
      background: #3e3e3e;
      color: #d4d4d4;
    }

    .json-view {
      display: none;
      background: #252526;
      border: 1px solid #3e3e3e;
      border-radius: 3px;
      padding: 12px;
      margin: 12px 0;
      font-size: 11px;
      overflow-x: auto;
      color: #858585;
    }

    .json-view.visible {
      display: block;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #3e3e3e;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #4e4e4e;
    }

    .error-message {
      background: #5a1d1d;
      border-left: 3px solid #f48771;
      padding: 12px;
      margin: 12px 0;
      border-radius: 3px;
      color: #f48771;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="panel">
      <div class="panel-header">
        <span>ðŸ“„</span>
        <span>Source Code</span>
      </div>
      <div class="panel-content">
        <div class="source-code" id="sourceCode"></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span>ðŸŒ³</span>
        <span>Abstract Syntax Tree</span>
        <button class="json-toggle" onclick="toggleJSON()">Show JSON</button>
      </div>
      <div class="panel-content">
        <div class="json-view" id="jsonView"></div>
        <div id="astOutput"></div>
      </div>
    </div>
  </div>

  <script>
    const DATA = /*DATA_PLACEHOLDER*/;
    const expandedNodes = new Set(['root', 'func-0']);
    
    // Auto-reload on file change
    let lastContent = JSON.stringify(DATA);
    setInterval(() => {
      fetch(window.location.href)
        .then(res => res.text())
        .then(html => {
          const match = html.match(/const DATA = (.+?);/);
          if (match) {
            const newContent = match[1];
            if (newContent !== lastContent) {
              console.log('ðŸ”„ Reloading...');
              window.location.reload();
            }
          }
        })
        .catch(() => {}); // Ignore errors
    }, 1000); // Check every second

    function toggleJSON() {
      const jsonView = document.getElementById('jsonView');
      const button = document.querySelector('.json-toggle');
      
      if (jsonView.classList.contains('visible')) {
        jsonView.classList.remove('visible');
        button.textContent = 'Show JSON';
      } else {
        jsonView.classList.add('visible');
        button.textContent = 'Hide JSON';
      }
    }

    function highlightSource(source) {
      return source
        .replace(/\bdefn\b/g, '<span class="keyword">defn</span>')
        .replace(/\berror\b/g, '<span class="keyword">error</span>')
        .replace(/(::|->)/g, '<span class="operator">$1</span>')
        .replace(/\b([a-z][a-zA-Z0-9_]*)\s*::/g, '<span class="function-name">$1</span> <span class="operator">::</span>')
        .replace(/\[([a-z])\]/g, '<span class="operator">[</span><span class="type">$1</span><span class="operator">]</span>')
        .replace(/\b([a-z])\b(?=\s*->)/g, '<span class="type">$1</span>')
        .replace(/"[^"]*"/g, '<span class="string">$&</span>')
        .replace(/--.*$/gm, '<span class="comment">$&</span>');
    }

    function renderAST(data) {
      if (Array.isArray(data)) {
        return '<div class="tree-node">' +
          '<div class="node-label" style="margin-bottom: 8px;">Program</div>' +
          '<div class="tree-children">' +
          data.map((item, i) => renderFunctionDef(item, 'func-' + i)).join('') +
          '</div></div>';
      }
      return '<div class="error-message">Unexpected AST structure</div>';
    }

    function renderFunctionDef(func, id) {
      const isExpanded = expandedNodes.has(id);
      
      let html = '<div class="tree-node">';
      html += '<div class="tree-node-header" onclick="toggleNode(\'' + id + '\')">';
      html += '<span class="expand-icon">' + (isExpanded ? 'â–¼' : 'â–¶') + '</span>';
      html += '<span class="node-label">FunctionDef</span>';
      html += '<span class="node-value">' + func.funName + '</span>';
      html += '</div>';

      if (isExpanded) {
        html += '<div class="tree-children">';
        
        html += '<div class="prop-value"><span class="prop-label">name:</span>';
        html += '<span class="node-value">' + func.funName + '</span></div>';
        
        html += renderTypeSignature(func.funTypeSignature, id + '-type');
        
        if (func.funDocstring) {
          html += '<div class="prop-value"><span class="prop-label">docstring:</span>';
          html += '<span class="string-value">"' + escapeHtml(func.funDocstring) + '"</span></div>';
        }
        
        html += renderClauses(func.funClauses, id + '-clauses');
        
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }

    function renderTypeSignature(typeSig, id) {
      const isExpanded = expandedNodes.has(id);
      
      let html = '<div class="tree-node">';
      html += '<div class="tree-node-header" onclick="toggleNode(\'' + id + '\')">';
      html += '<span class="expand-icon">' + (isExpanded ? 'â–¼' : 'â–¶') + '</span>';
      html += '<span class="node-label">TypeSignature</span>';
      html += '<span class="node-preview type-expr">' + renderTypePreview(typeSig.typeExpr) + '</span>';
      html += '</div>';

      if (isExpanded) {
        html += '<div class="tree-children">';
        html += '<div class="prop-value"><span class="prop-label">typeVars:</span>';
        html += '<span class="node-value">[' + typeSig.typeVars.join(', ') + ']</span></div>';
        html += '<div class="prop-value"><span class="prop-label">typeExpr:</span>';
        html += '<span class="type-expr">' + renderTypePreview(typeSig.typeExpr) + '</span></div>';
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function renderTypePreview(type) {
      if (type.tag === 'TVar') {
        return type.contents;
      } else if (type.tag === 'TList') {
        return '[' + renderTypePreview(type.contents) + ']';
      } else if (type.tag === 'TFun') {
        return renderTypePreview(type.contents[0]) + ' â†’ ' + renderTypePreview(type.contents[1]);
      } else if (type.tag === 'TCon') {
        return type.contents;
      } else if (type.tag === 'TApp') {
        return renderTypePreview(type.contents[0]) + ' ' + renderTypePreview(type.contents[1]);
      }
      return JSON.stringify(type);
    }

    function renderClauses(clauses, id) {
      const isExpanded = expandedNodes.has(id);
      
      let html = '<div class="tree-node">';
      html += '<div class="tree-node-header" onclick="toggleNode(\'' + id + '\')">';
      html += '<span class="expand-icon">' + (isExpanded ? 'â–¼' : 'â–¶') + '</span>';
      html += '<span class="node-label">Clauses</span>';
      html += '<span class="node-preview">(' + clauses.length + ')</span>';
      html += '</div>';

      if (isExpanded) {
        html += '<div class="tree-children">';
        clauses.forEach((clause, i) => {
          html += renderClause(clause, id + '-clause-' + i, i);
        });
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function renderClause(clause, id, index) {
      const isExpanded = expandedNodes.has(id);
      const patternPreview = clause.clausePatterns.map(p => renderPatternPreview(p)).join(' ');
      const bodyPreview = renderExprPreview(clause.clauseBody);
      
      let html = '<div class="tree-node">';
      html += '<div class="tree-node-header" onclick="toggleNode(\'' + id + '\')">';
      html += '<span class="expand-icon">' + (isExpanded ? 'â–¼' : 'â–¶') + '</span>';
      html += '<span class="node-label">Clause</span>';
      html += '<span class="node-preview">' + patternPreview + ' â†’ ' + bodyPreview + '</span>';
      html += '</div>';

      if (isExpanded) {
        html += '<div class="tree-children">';
        html += '<div class="prop-value"><span class="prop-label">patterns:</span>';
        html += '<span class="pattern-expr">' + patternPreview + '</span></div>';
        html += '<div class="prop-value"><span class="prop-label">body:</span>';
        html += '<span class="expr-expr">' + bodyPreview + '</span></div>';
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function renderPatternPreview(pattern) {
      if (pattern.tag === 'PVar') {
        return pattern.contents;
      } else if (pattern.tag === 'PWild') {
        return '_';
      } else if (pattern.tag === 'PList') {
        return '[' + pattern.contents.map(p => renderPatternPreview(p)).join(', ') + ']';
      } else if (pattern.tag === 'PCons') {
        return '[' + renderPatternPreview(pattern.contents[0]) + '|' + renderPatternPreview(pattern.contents[1]) + ']';
      } else if (pattern.tag === 'PLit') {
        return renderLiteral(pattern.contents);
      }
      return '?';
    }

    function renderExprPreview(expr) {
      if (expr.tag === 'EVar') {
        return expr.contents;
      } else if (expr.tag === 'EError') {
        return 'error ' + expr.contents;
      } else if (expr.tag === 'EApp') {
        return renderExprPreview(expr.contents[0]) + ' ' + renderExprPreview(expr.contents[1]);
      } else if (expr.tag === 'ELit') {
        return renderLiteral(expr.contents);
      } else if (expr.tag === 'EList') {
        return '[' + expr.contents.map(e => renderExprPreview(e)).join(', ') + ']';
      }
      return '?';
    }

    function renderLiteral(lit) {
      if (lit.tag === 'LInt') {
        return lit.contents.toString();
      } else if (lit.tag === 'LString') {
        return '"' + lit.contents + '"';
      } else if (lit.tag === 'LAtom') {
        return lit.contents;
      }
      return '?';
    }

    function toggleNode(id) {
      if (expandedNodes.has(id)) {
        expandedNodes.delete(id);
      } else {
        expandedNodes.add(id);
      }
      document.getElementById('astOutput').innerHTML = renderAST(DATA.ast);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    if (DATA && DATA.source && DATA.ast) {
      document.getElementById('sourceCode').innerHTML = highlightSource(DATA.source);
      document.getElementById('astOutput').innerHTML = renderAST(DATA.ast);
      document.getElementById('jsonView').textContent = JSON.stringify(DATA.ast, null, 2);
    } else {
      document.getElementById('astOutput').innerHTML = 
        '<div class="error-message">No data loaded. Run: ./Parser --visualize src.amor</div>';
    }
  </script>
</body>
</html>
